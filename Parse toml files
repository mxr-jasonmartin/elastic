# Directory where .toml files are located
$directoryPath = "C:\Users\ja008827\Downloads\vscode-directory\Elastic Detection Rules"

# Ensure the directory exists
if (-not (Test-Path $directoryPath)) {
    Write-Host "Directory does not exist: $directoryPath"
    exit
}

# Flag to decide where to output results
$outputToFile = $true

# Create a datetime stamp for the filename if outputting to file
if ($outputToFile) {
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $outputFile = "C:\Users\ja008827\Downloads\vscode-directory\output_$timestamp.csv"
   
    # Create CSV header
    "Name,Type,Result" | Out-File -FilePath $outputFile -Encoding utf8
}

# Get all .toml files recursively
Get-ChildItem -Path $directoryPath -Recurse -Filter *.toml | ForEach-Object {
    $file = $_.FullName
    $content = Get-Content -Path $file

    # Initialize variables for name, index, query, and matches
    $name = ""
    $queryRaw = ""
    $indexMatches = @()  # For index values
    $queryMatches = @()  # For query fields

    # Flags to track sections and collection states
    $inRuleSection = $false
    $collectingQuery = $false

    # Process each line to extract name, index, and query
    foreach ($line in $content) {
        # Check if we're entering the [rule] section
        if ($line -eq "[rule]") {
            $inRuleSection = $true
        }
        
        # Extract index values
        if ($line -match '^index\s*=\s*\[') {
            if ($inRuleSection) {
                $matches = [regex]::Matches($line, '"([^"]*)"')
                foreach($match in $matches) {
                    $indexMatches += $match.Groups[1].Value
                }
            }
        }
        
        # Extract name if in the rule section
        if ($line -match '^name\s*=\s*"([^"]*)"') {
            if ($inRuleSection) {    
                $name = $Matches[1]
            }
        }
        
        # Start collecting query when we hit the query line
        if ($line -eq "query = '''") {
            $collectingQuery = $true
            $inRuleSection = $false
        }
        
        # Collect query content
        if ($collectingQuery) {
            if ($line -eq "'''") {
                # End of query, process collected content
                $collectingQuery = $false
                $queryRaw += $line.Substring(0, $line.IndexOf("'''"))
                $matches = [regex]::Matches($queryRaw, '(?:^|\s|\(|\[)([A-Za-z0-9_.]+)(?=\s*(?:==|!=|>|<|in|:))')
                foreach($match in $matches) {
                    $queryMatches += $match.Groups[1].Value
                }
            } else {
                # Append line to query content
                $queryRaw += $line
            }
        }
    }

    # Output results
    if ($outputToFile) {
        # Write index matches to file
        foreach($indexMatch in $indexMatches) {
            @("$name,Index,$indexMatch") | Out-File -FilePath $outputFile -Append -Encoding utf8
        }
        # Write query field matches to file
        foreach($queryMatch in $queryMatches) {
            @("$name,Field,$queryMatch") | Out-File -FilePath $outputFile -Append -Encoding utf8
        }
    } else {
        # Output to console if not writing to file
        Write-Host "Name: $name"
        Write-Host "Indexes: $indexMatches"
        Write-Host "Required Fields: $queryMatches"
        Write-Host "-------------------"
    }
}

# Final output message
if ($outputToFile) {
    Write-Host "Data extraction completed. Results saved to $outputFile"
} else {
    Write-Host "Data extraction completed. Results output to screen."
}